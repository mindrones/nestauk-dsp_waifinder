import {
	getId,
	getValue,
	objectToKeyValueArray,
} from '@svizzle/utils';
import * as _ from 'lamb';
import {derived, writable} from 'svelte/store';

/* input data */

export const _data = writable({
	org_types: {},
	orgs: [],
	places: [],
});

/* geo */

export const _placesById = derived(
	_data,
	({places}) => _.index(places, getId)
)
export const _regionsById = derived(
	_data,
	_.pipe([
		_.getKey('places'),
		_.indexBy(_.getKey('region_id')),
		_.mapValuesWith(_.pick(['region_id', 'region_name']))
	])
);

/* orgs */

export const _orgs = derived(
	[_data, _placesById],
	([{orgs, org_types}, placesById]) => _.map(orgs,
		org => ({
			...org,
			place: placesById[org.place_id],
			types: _.map(org.types, typeId => org_types[typeId])
		})
	)
);


/* barchat by place */

const makeKeyPlaceIdValueOrgsCount = _.pipe([
	_.countBy(_.getKey('place_id')),
	objectToKeyValueArray,
	_.sortWith([_.sorterDesc(getValue)])
]);
export const _keyPlaceLabelValueOrgsCount = derived(
	[_orgs, _placesById],
	([orgs, placesById]) => _.map(
		makeKeyPlaceIdValueOrgsCount(orgs),
		({key, value}) => ({
			key: `${placesById[key].name} (${placesById[key].type})`,
			value
		})
	)
);

/* barchat by region */

const makeKeyRegionIdValueOrgsCount = _.pipe([
	_.countBy(_.getPath('place.region_id')),
	objectToKeyValueArray,
	_.sortWith([_.sorterDesc(getValue)]),
]);
export const _keyRegionLabelValueOrgsCount = derived(
	[_orgs, _regionsById],
	([orgs, regionsById]) => _.map(
		makeKeyRegionIdValueOrgsCount(orgs),
		({key, value}) => ({
			key: `${regionsById[key].region_name} (${key})`,
			value
		})
	)
);
