<script>
	import Link from '@svizzle/ui/src/Link.svelte';
	import Icon from '@svizzle/ui/src/icons/Icon.svelte';
	import Link2 from '@svizzle/ui/src/icons/feather/Link2.svelte';
	import * as _ from 'lamb';

	import {_isSmallScreen} from 'app/stores/layout';
	import {
		asyncUpdateTopicDetails,
		clearActiveTopic
	} from 'app/stores/topics';
	import {getTopicLabel} from 'app/utils/dataUtils';
	import {getWikipediaURL} from 'app/utils/dbpedia';

	import Pill from './Pill.svelte';

	export let item;
	export let minScore = 60;

	$: postCode = item?.location?.postcode || '';
	$: place = item?.place?.name || '';
	$: sep = (postCode && place) ? ' - ' : '';
	$: address = `${postCode}${sep}${place}`;
	$: topics = _.filter(item?.topics || [], ({score}) => score >= minScore);
	$: types = item?.types || [];
</script>

<div class='DetailCard'>

	<!-- row 1 -->

	<div class='flex'>
		<span class='name'>{item?.name || ''}</span>
		{#if item?.url}
			<Link
				href={item.url}
				target='_blank'
			>
				<Icon
					glyph={Link2}
					size={20}
				/>
			</Link>
		{/if}
	</div>

	<!-- row 2 -->

	<p class='description'>{item?.description || ''}</p>

	<!-- row 3 -->

	<div class='flex wrap'>
		{#if address !== ''}
			<div class='tag address'>
				<span>{address}</span>
			</div>
		{/if}
		{#each types as type}
			<div class='tag type'>
				<span>{type}</span>
			</div>
		{/each}
	</div>

	<!-- row 4 -->

	<div class='flex wrap topics'>
		{#if $_isSmallScreen}
			{#each topics as {id, score}}
				<div on:click={() => asyncUpdateTopicDetails(id)}>
					<Pill
						{score}
						label={getTopicLabel(id)}
					/>
				</div>
			{/each}
		{:else}
			{#each topics as {id, score}}
				<div class='topic'>
					<Link
						href={getWikipediaURL(id)}
						target='_blank'
					>
						<div
							on:mouseenter={() => asyncUpdateTopicDetails(id)}
							on:mouseleave={clearActiveTopic}
						>
							<Pill
								{score}
								label={getTopicLabel(id)}
							/>
						</div>
					</Link>
				</div>
			{/each}
		{/if}
	</div>
</div>

<style>
	.DetailCard {
		display: grid;
		gap: 0.8em;
		padding: 1em;
	}

	.flex {
		align-items: center;
		display: flex;
		gap: 0.4rem;
		overflow-x: hidden;
	}
	.wrap {
		flex-wrap: wrap;
	}

	.name {
		font-size: 1.2em;
	}

	.tag span {
		font-style: italic;
		padding: 0.2em 0.5em;
	}
	.address span {
		background-color: aquamarine;
	}
	.type span {
		background-color: cornsilk;
	}

	.description {
		/* These `-webkit` properties work in Firefox and Edge and Safari 15.4. */
		-webkit-box-orient: vertical;
		-webkit-line-clamp: 3;
		display: -webkit-box;
		overflow: hidden;
		text-overflow: ellipsis;
	}

	.topic {
		max-width: 100%;
	}
</style>
